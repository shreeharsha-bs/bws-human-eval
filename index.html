<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Response Quality Evaluation</title>

<!-- jsPsych 7 (served by cognition.run when you select a version) -->
<script src="jspsych/jspsych.js"></script>
<link rel="stylesheet" href="jspsych/jspsych.css">
<!-- JATOS (served by cognition.run) -->
<script src="jatos.js"></script>

<style>
  /* ── Override jsPsych defaults ── */
  html, body { margin: 0 !important; padding: 0 !important; min-height: 100vh; }
  .jspsych-display-element {
    display: block !important;
    overflow: visible !important;
    max-width: none !important;
  }
  #jspsych-content, .jspsych-content {
    max-width: none !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  .jspsych-content-wrapper {
    display: block !important;
    overflow: visible !important;
    max-width: none !important;
    padding: 0 !important;
  }

  /* ── Base ── */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f0f2f5;
    color: #1a1a2e;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* ── Top bar ── */
  .top-bar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
    background: #fff; border-bottom: 1px solid #d0d0d0;
    padding: 10px 24px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 1px 4px rgba(0,0,0,.06);
  }
  .progress-text { font-size: 14px; color: #555; }
  .progress-bar-bg {
    flex: 1; max-width: 400px; height: 8px; background: #e0e0e0;
    border-radius: 4px; margin: 0 16px; overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%; background: linear-gradient(90deg, #4361ee, #7209b7);
    border-radius: 4px; transition: width 0.4s ease;
  }
  .timer { font-size: 13px; color: #888; }

  /* ── Container ── */
  .bws-container {
    max-width: 1200px; margin: 0 auto;
    padding: 56px 20px 80px;
  }

  /* ── Instructions panel ── */
  .instructions {
    background: #fff; border-radius: 12px;
    padding: 32px; margin-bottom: 24px;
    border-left: 4px solid #4361ee;
    box-shadow: 0 2px 8px rgba(0,0,0,.04);
  }
  .instructions h1 { font-size: 22px; margin-bottom: 12px; }
  .instructions h2 { font-size: 17px; margin: 16px 0 8px; color: #4361ee; }
  .instructions p, .instructions li { font-size: 14px; color: #444; margin-bottom: 6px; }
  .instructions ul { padding-left: 20px; }
  .instructions .highlight {
    background: #fff3cd; padding: 8px 12px; border-radius: 6px;
    font-size: 13px; margin-top: 12px;
  }
  .btn-start {
    display: inline-block; margin-top: 16px; padding: 12px 32px;
    background: #4361ee; color: #fff; border: none; border-radius: 8px;
    font-size: 15px; font-weight: 600; cursor: pointer;
    transition: background 0.2s;
  }
  .btn-start:hover { background: #3a56d4; }

  /* ── Trial card ── */
  .trial-card {
    background: #fff; border-radius: 12px;
    padding: 28px 32px; margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
  }
  .trial-card.hidden { display: none; }
  .scenario-badge {
    display: inline-block; padding: 3px 10px;
    background: #e8eaf6; color: #4361ee; border-radius: 12px;
    font-size: 12px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.5px; margin-bottom: 12px;
  }
  .question-text {
    font-size: 15px; color: #333; font-style: italic;
    background: #f8f9fa; padding: 12px 16px; border-radius: 8px;
    margin-bottom: 20px; border-left: 3px solid #adb5bd;
  }

  /* ── Response grid ── */
  .response-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px; margin-bottom: 24px;
  }
  .response-card {
    border: 2px solid #e0e0e0; border-radius: 10px;
    overflow: hidden; transition: border-color 0.2s, box-shadow 0.2s;
    position: relative;
  }
  .response-card:hover { border-color: #b0b0b0; }
  .response-card.selected-best { border-color: #2ecc71; box-shadow: 0 0 0 2px rgba(46,204,113,.25); }
  .response-card.selected-worst { border-color: #e74c3c; box-shadow: 0 0 0 2px rgba(231,76,60,.25); }

  .response-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px; background: #f8f9fa; border-bottom: 1px solid #eee;
    cursor: pointer; user-select: none;
  }
  .response-label { font-weight: 700; font-size: 15px; color: #4361ee; }
  .expand-icon { font-size: 12px; color: #888; transition: transform 0.2s; }
  .expand-icon.open { transform: rotate(180deg); }

  .response-preview {
    padding: 12px 14px; font-size: 13px; color: #555;
    max-height: 60px; overflow: hidden; position: relative;
  }
  .response-preview::after {
    content: ''; position: absolute; bottom: 0; left: 0; right: 0;
    height: 30px; background: linear-gradient(transparent, #fff);
  }
  .response-full {
    padding: 12px 14px; font-size: 13px; color: #333;
    line-height: 1.6; display: none; white-space: pre-wrap;
  }
  .response-card.expanded .response-preview { display: none; }
  .response-card.expanded .response-full { display: block; }
  .response-card.expanded .response-preview::after { display: none; }

  .expand-all-btn {
    display: inline-block; margin-bottom: 12px; padding: 6px 14px;
    background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px;
    font-size: 12px; color: #555; cursor: pointer;
  }
  .expand-all-btn:hover { background: #e4e4e4; }

  /* ── Selection area ── */
  .selection-area {
    background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 8px;
  }
  .selection-area h3 { font-size: 15px; margin-bottom: 16px; color: #333; }
  .selection-row {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 14px; flex-wrap: wrap;
  }
  .selection-row label { font-size: 14px; font-weight: 600; min-width: 120px; }
  .selection-row .best-label { color: #2ecc71; }
  .selection-row .worst-label { color: #e74c3c; }
  .sel-btn {
    padding: 6px 18px; border: 2px solid #ddd; border-radius: 6px;
    background: #fff; font-size: 14px; font-weight: 600; cursor: pointer;
    transition: all 0.15s; color: #555;
  }
  .sel-btn:hover { border-color: #999; }
  .sel-btn.best-selected { background: #2ecc71; color: #fff; border-color: #2ecc71; }
  .sel-btn.worst-selected { background: #e74c3c; color: #fff; border-color: #e74c3c; }
  .sel-btn.disabled { opacity: 0.35; pointer-events: none; }

  .selection-warning { color: #e74c3c; font-size: 13px; margin-top: 8px; display: none; }

  /* ── Navigation ── */
  .nav-bar {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 20px; padding-top: 16px; border-top: 1px solid #eee;
  }
  .btn-nav {
    padding: 10px 28px; border: none; border-radius: 8px;
    font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  }
  .btn-prev { background: #e0e0e0; color: #555; }
  .btn-prev:hover { background: #ccc; }
  .btn-next { background: #4361ee; color: #fff; }
  .btn-next:hover { background: #3a56d4; }
  .btn-next:disabled { background: #bbb; cursor: not-allowed; }
  .btn-submit { background: #2ecc71; color: #fff; }
  .btn-submit:hover { background: #27ae60; }

  /* ── Break screen ── */
  .break-screen { text-align: center; padding: 60px 20px; }
  .break-screen h2 { font-size: 20px; margin-bottom: 12px; color: #4361ee; }
  .break-screen p { font-size: 15px; color: #666; margin-bottom: 20px; }

  /* ── Completion ── */
  .completion { text-align: center; padding: 60px 20px; }
  .completion h1 { font-size: 24px; color: #2ecc71; margin-bottom: 12px; }
  .completion p { font-size: 15px; color: #555; }
  .completion .code {
    font-size: 20px; font-weight: bold; color: #4361ee;
    background: #e8eaf6; padding: 8px 20px; border-radius: 8px;
    display: inline-block; margin: 16px 0; letter-spacing: 2px;
  }
  .hidden { display: none !important; }

  /* ── Save status ── */
  .save-status {
    display: flex; align-items: center; gap: 8px;
    padding: 12px 16px; border-radius: 8px; font-size: 14px; margin-top: 12px;
  }
  .save-status.saving { background: #fff3e0; color: #e65100; }
  .save-status.saved  { background: #e8f5e9; color: #2e7d32; }
  .save-status.failed  { background: #ffebee; color: #c62828; }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid #e65100; border-top-color: transparent;
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .response-grid { grid-template-columns: 1fr; }
    .bws-container { padding: 56px 12px 80px; }
    .trial-card { padding: 16px; }
  }
</style>
</head>

<body></body>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// Configuration
// ═══════════════════════════════════════════════════════════════════════════
var PROLIFIC_COMPLETION_URL = "https://app.prolific.com/submissions/complete?cc=CV4XUPGK";
var RESEARCHER_EMAIL = "shbs@kth.se";
var BREAK_INTERVAL = 7;

// ═══════════════════════════════════════════════════════════════════════════
// Main experiment — renders into any target element
// ═══════════════════════════════════════════════════════════════════════════
function runBwsExperiment(targetElement) {

  // ── State ──
  var trials = [];
  var currentTrialIdx = -1;
  var responses = {};
  var startTime = null;
  var trialStartTime = null;
  var participantId = null;
  var assignedSlot = null;
  var currentBest = null;
  var currentWorst = null;
  var completionPayload = null;
  var timerInterval = null;

  // ── Render shell HTML ──
  targetElement.innerHTML =
    '<div class="top-bar" id="topBar">' +
      '<span class="progress-text" id="progressText">0 / 0</span>' +
      '<div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>' +
      '<span class="timer" id="timer">00:00</span>' +
    '</div>' +

    '<div class="bws-container">' +

      // Instructions
      '<div class="instructions" id="instructionsPanel">' +
        '<h1>Response Quality Evaluation</h1>' +
        '<p>Thank you for participating in this study. You will be evaluating AI-generated responses to various everyday scenarios.</p>' +
        '<h2>Your Task</h2>' +
        '<p>On each screen, you will see a <strong>question/scenario</strong> and <strong>4 different AI-generated responses</strong> (labeled A, B, C, D).</p>' +
        '<p>For each set, you need to:</p>' +
        '<ul>' +
          '<li>Read all 4 responses</li>' +
          '<li>Select the <strong style="color:#2ecc71">MOST helpful</strong> response</li>' +
          '<li>Select the <strong style="color:#e74c3c">LEAST helpful</strong> response</li>' +
        '</ul>' +
        '<h2>What Makes a Response &ldquo;Helpful&rdquo;?</h2>' +
        '<ul>' +
          '<li><strong>Relevance</strong> &mdash; Does it actually address the question?</li>' +
          '<li><strong>Specificity</strong> &mdash; Does it give concrete, actionable advice?</li>' +
          '<li><strong>Quality</strong> &mdash; Is it well-organized and easy to follow?</li>' +
          '<li><strong>Respect</strong> &mdash; Does it treat the person asking as competent?</li>' +
        '</ul>' +
        '<h2>Important Notes</h2>' +
        '<ul>' +
          '<li>There are no right or wrong answers &mdash; we want your honest judgment</li>' +
          '<li>Please read all 4 responses before making your selection</li>' +
          '<li>You <strong>cannot</strong> select the same response as both best and worst</li>' +
          '<li>Some items are quality checks &mdash; please pay attention throughout</li>' +
          '<li>The study takes approximately <strong>15&ndash;18 minutes</strong></li>' +
        '</ul>' +
        '<div class="highlight">&9201; You can take short breaks between items. A break prompt will appear periodically.</div>' +
        '<button class="btn-start" id="btnStart">I understand &mdash; Start the study</button>' +
      '</div>' +

      // Trial container
      '<div id="trialContainer" class="hidden"></div>' +

      // Completion screen
      '<div id="completionScreen" class="trial-card hidden">' +
        '<div class="completion">' +
          '<h1>&#10003; Study Complete!</h1>' +
          '<p>Thank you for your careful evaluation!</p>' +

          '<div id="saveStatusBox" style="background:#e8f5e9;border-radius:10px;padding:24px;margin:20px 0;text-align:left;">' +
            '<h3 style="margin-bottom:12px;color:#2e7d32;">&#128190; Saving your results&hellip;</h3>' +
            '<div class="save-status saving" id="saveStatusMsg"><div class="spinner"></div><span>Uploading responses to server&hellip;</span></div>' +
          '</div>' +

          '<div id="fallbackDownload" class="hidden" style="text-align:left;">' +
            '<div style="background:#e8f5e9;border-radius:10px;padding:24px;margin:20px 0;">' +
              '<h3 style="margin-bottom:12px;color:#2e7d32;">&#128229; Download your results</h3>' +
              '<p style="font-size:14px;color:#555;margin-bottom:12px;">If the download did not start automatically, click below:</p>' +
              '<button class="btn-start" id="downloadBtn" style="background:#2e7d32;">&#11015; Download Results File</button>' +
              '<p style="font-size:12px;color:#888;margin-top:8px;" id="downloadStatus"></p>' +
            '</div>' +
            '<div style="background:#e3f2fd;border-radius:10px;padding:24px;margin:20px 0;">' +
              '<h3 style="margin-bottom:12px;color:#1565c0;">&#128231; Email the file</h3>' +
              '<p style="font-size:14px;color:#555;">Send the downloaded <code>.json</code> file to:</p>' +
              '<div style="font-size:18px;font-weight:bold;color:#1565c0;margin:12px 0;font-family:monospace;" id="emailAddress"></div>' +
              '<p style="font-size:13px;color:#888;">Subject: <strong>BWS Evaluation &mdash; <span id="pidDisplay"></span></strong></p>' +
            '</div>' +
          '</div>' +

          '<div style="background:#fff3e0;border-radius:10px;padding:24px;margin:20px 0;text-align:left;">' +
            '<h3 style="margin-bottom:12px;color:#e65100;">&#127915; Return to Prolific</h3>' +
            '<p style="font-size:14px;color:#555;margin-bottom:8px;">Copy this completion code and paste it into Prolific:</p>' +
            '<div class="code" id="completionCode">LOADING...</div>' +
            '<p style="margin-top:12px;"><button class="btn-start" id="btnProlific" style="background:#e65100;" disabled>Saving&hellip; please wait</button></p>' +
          '</div>' +
        '</div>' +
      '</div>' +

    '</div>';

  // ── Wire initial event listeners ──
  document.getElementById('btnStart').addEventListener('click', startStudy);
  document.getElementById('downloadBtn').addEventListener('click', downloadResults);
  document.getElementById('btnProlific').addEventListener('click', redirectToProlific);

  // ── Helpers ──
  function getUrlParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  function escapeHtml(str) {
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // ── Load trial data ──
  function loadTrialData() {
    var paths = ['trials_by_participant.json', './trials_by_participant.json', 'stimuli/trials_by_participant.json'];
    function tryNext(i) {
      if (i >= paths.length) {
        alert('Error loading trial data. Please refresh the page.');
        return Promise.resolve(null);
      }
      return fetch(paths[i]).then(function(r) {
        if (r.ok) return r.json();
        return tryNext(i + 1);
      }).catch(function() { return tryNext(i + 1); });
    }
    return tryNext(0);
  }

  // ── Initialize ──
  function init() {
    participantId = getUrlParam('PROLIFIC_PID') || getUrlParam('participant') || 'test_' + Math.random().toString(36).slice(2, 8);
    document.getElementById('progressText').textContent = 'Participant: ' + participantId.slice(0, 8) + '...';

    loadTrialData().then(function(data) {
      if (!data) return;
      var pKeys = Object.keys(data);
      assignedSlot = getUrlParam('participant');
      if (!assignedSlot) {
        var hash = 0;
        for (var i = 0; i < participantId.length; i++) {
          hash = ((hash << 5) - hash) + participantId.charCodeAt(i);
          hash |= 0;
        }
        assignedSlot = pKeys[Math.abs(hash) % pKeys.length];
      }
      trials = data[assignedSlot] || data[pKeys[0]];
      console.log('Loaded ' + trials.length + ' trials for slot ' + assignedSlot);
    });
  }

  // ── Timer ──
  function updateTimer() {
    if (!startTime) return;
    var elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('timer').textContent =
      String(Math.floor(elapsed / 60)).padStart(2, '0') + ':' + String(elapsed % 60).padStart(2, '0');
  }

  // ── Start study ──
  function startStudy() {
    document.getElementById('instructionsPanel').classList.add('hidden');
    document.getElementById('trialContainer').classList.remove('hidden');
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
    showTrial(0);
  }

  // ── Render trial ──
  function showTrial(idx) {
    if (idx >= trials.length) { showCompletion(); return; }
    if (idx > 0 && idx % BREAK_INTERVAL === 0 && !responses['break_' + idx]) {
      showBreak(idx);
      return;
    }

    currentTrialIdx = idx;
    trialStartTime = Date.now();
    currentBest = null;
    currentWorst = null;
    var t = trials[idx];

    document.getElementById('progressText').textContent = (idx + 1) + ' / ' + trials.length;
    document.getElementById('progressFill').style.width = Math.round((idx / trials.length) * 100) + '%';

    var prev = responses[t.trial_id];
    var container = document.getElementById('trialContainer');
    var scenarioLabel = t.scenario.replace(/_/g, ' ');
    var labels = ['A', 'B', 'C', 'D'];

    var cardsHtml = labels.map(function(l) {
      return '<div class="response-card expanded" id="card_' + l + '">' +
        '<div class="response-header" data-label="' + l + '">' +
          '<span class="response-label">Response ' + l + '</span>' +
          '<span class="expand-icon open" id="icon_' + l + '">&#9660;</span>' +
        '</div>' +
        '<div class="response-preview">' + escapeHtml(t.responses[l]).slice(0, 150) + '&hellip;</div>' +
        '<div class="response-full">' + escapeHtml(t.responses[l]) + '</div>' +
      '</div>';
    }).join('');

    var bestBtns = labels.map(function(l) {
      return '<button class="sel-btn" data-action="best" data-label="' + l + '" id="best_' + l + '">' + l + '</button>';
    }).join('');
    var worstBtns = labels.map(function(l) {
      return '<button class="sel-btn" data-action="worst" data-label="' + l + '" id="worst_' + l + '">' + l + '</button>';
    }).join('');

    var navHtml =
      '<button class="btn-nav btn-prev" id="btnPrev"' + (idx === 0 ? ' style="visibility:hidden"' : '') + '>&larr; Previous</button>' +
      '<span style="font-size:13px;color:#888;">Trial ' + (idx + 1) + ' of ' + trials.length + '</span>' +
      (idx === trials.length - 1
        ? '<button class="btn-nav btn-submit" id="btnNext" disabled>Submit &amp; Finish</button>'
        : '<button class="btn-nav btn-next" id="btnNext" disabled>Next &rarr;</button>');

    container.innerHTML =
      '<div class="trial-card">' +
        '<span class="scenario-badge">' + scenarioLabel + '</span>' +
        '<div class="question-text">' + escapeHtml(t.question) + '</div>' +
        '<button class="expand-all-btn" id="expandAllBtn">&#9650; Collapse all responses</button>' +
        '<div class="response-grid">' + cardsHtml + '</div>' +
        '<div class="selection-area">' +
          '<h3>Your judgment:</h3>' +
          '<div class="selection-row"><label class="best-label">&#10003; MOST helpful:</label>' + bestBtns + '</div>' +
          '<div class="selection-row"><label class="worst-label">&#10007; LEAST helpful:</label>' + worstBtns + '</div>' +
          '<div class="selection-warning" id="selWarning">You cannot select the same response as both best and worst.</div>' +
        '</div>' +
        '<div class="nav-bar">' + navHtml + '</div>' +
      '</div>';

    // Wire event handlers for this trial
    document.getElementById('expandAllBtn').addEventListener('click', function() { toggleExpandAll(this); });
    document.querySelectorAll('.response-header').forEach(function(h) {
      h.addEventListener('click', function() { toggleExpand(this.dataset.label); });
    });
    document.querySelectorAll('[data-action="best"]').forEach(function(b) {
      b.addEventListener('click', function() { selectBest(this.dataset.label); });
    });
    document.querySelectorAll('[data-action="worst"]').forEach(function(b) {
      b.addEventListener('click', function() { selectWorst(this.dataset.label); });
    });
    document.getElementById('btnNext').addEventListener('click', nextTrial);
    if (idx > 0) document.getElementById('btnPrev').addEventListener('click', prevTrial);

    // Restore previous selection
    if (prev) {
      if (prev.best) selectBest(prev.best);
      if (prev.worst) selectWorst(prev.worst);
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ── Break screen ──
  function showBreak(nextIdx) {
    var container = document.getElementById('trialContainer');
    var pct = Math.round((nextIdx / trials.length) * 100);
    container.innerHTML =
      '<div class="trial-card"><div class="break-screen">' +
        '<h2>&#9749; Quick break</h2>' +
        '<p>You have completed ' + nextIdx + ' of ' + trials.length + ' items (' + pct + '%).</p>' +
        '<p>Take a moment to rest your eyes if needed.</p>' +
        '<button class="btn-start" id="btnResume">Continue &rarr;</button>' +
      '</div></div>';
    document.getElementById('btnResume').addEventListener('click', function() { showTrial(nextIdx); });
    responses['break_' + nextIdx] = true;
  }

  // ── Expand / collapse ──
  function toggleExpand(label) {
    document.getElementById('card_' + label).classList.toggle('expanded');
    document.getElementById('icon_' + label).classList.toggle('open');
  }

  function toggleExpandAll(btn) {
    var cards = document.querySelectorAll('.response-card');
    var allExpanded = Array.from(cards).every(function(c) { return c.classList.contains('expanded'); });
    cards.forEach(function(c) {
      if (allExpanded) c.classList.remove('expanded');
      else c.classList.add('expanded');
    });
    document.querySelectorAll('.expand-icon').forEach(function(i) {
      if (allExpanded) i.classList.remove('open');
      else i.classList.add('open');
    });
    btn.innerHTML = allExpanded ? '&#9660; Expand all responses' : '&#9650; Collapse all responses';
  }

  // ── Selection logic ──
  function selectBest(label) {
    if (label === currentWorst) {
      document.getElementById('selWarning').style.display = 'block';
      setTimeout(function() { document.getElementById('selWarning').style.display = 'none'; }, 2000);
      return;
    }
    ['A','B','C','D'].forEach(function(l) {
      document.getElementById('best_' + l).classList.remove('best-selected');
      document.getElementById('card_' + l).classList.remove('selected-best');
      document.getElementById('worst_' + l).classList.remove('disabled');
    });
    document.getElementById('best_' + label).classList.add('best-selected');
    document.getElementById('card_' + label).classList.add('selected-best');
    document.getElementById('worst_' + label).classList.add('disabled');
    currentBest = label;
    checkComplete();
  }

  function selectWorst(label) {
    if (label === currentBest) {
      document.getElementById('selWarning').style.display = 'block';
      setTimeout(function() { document.getElementById('selWarning').style.display = 'none'; }, 2000);
      return;
    }
    ['A','B','C','D'].forEach(function(l) {
      document.getElementById('worst_' + l).classList.remove('worst-selected');
      document.getElementById('card_' + l).classList.remove('selected-worst');
      document.getElementById('best_' + l).classList.remove('disabled');
    });
    document.getElementById('worst_' + label).classList.add('worst-selected');
    document.getElementById('card_' + label).classList.add('selected-worst');
    document.getElementById('best_' + label).classList.add('disabled');
    currentWorst = label;
    checkComplete();
  }

  function checkComplete() {
    var btn = document.getElementById('btnNext');
    if (currentBest && currentWorst && currentBest !== currentWorst) btn.disabled = false;
  }

  // ── Navigation ──
  function saveCurrentResponse() {
    if (currentTrialIdx < 0 || currentTrialIdx >= trials.length) return;
    var t = trials[currentTrialIdx];
    responses[t.trial_id] = {
      trial_id: t.trial_id,
      trial_type: t.trial_type,
      best: currentBest,
      worst: currentWorst,
      time_ms: Date.now() - trialStartTime,
      timestamp: new Date().toISOString()
    };
  }

  function nextTrial() {
    saveCurrentResponse();
    currentBest = null;
    currentWorst = null;
    if (currentTrialIdx >= trials.length - 1) showCompletion();
    else showTrial(currentTrialIdx + 1);
  }

  function prevTrial() {
    saveCurrentResponse();
    currentBest = null;
    currentWorst = null;
    if (currentTrialIdx > 0) showTrial(currentTrialIdx - 1);
  }

  // ── Completion ──
  function showCompletion() {
    if (timerInterval) clearInterval(timerInterval);
    document.getElementById('trialContainer').classList.add('hidden');
    document.getElementById('completionScreen').classList.remove('hidden');
    document.getElementById('progressFill').style.width = '100%';
    document.getElementById('progressText').textContent = trials.length + ' / ' + trials.length + ' \u2713';

    var code = 'BWS' + Math.random().toString(36).slice(2, 8).toUpperCase();
    document.getElementById('completionCode').textContent = code;

    completionPayload = {
      participant_id: participantId,
      assigned_slot: assignedSlot,
      completion_code: code,
      total_time_ms: Date.now() - startTime,
      trials_completed: Object.keys(responses).filter(function(k) { return k.indexOf('break_') !== 0; }).length,
      responses: responses,
      user_agent: navigator.userAgent,
      timestamp: new Date().toISOString()
    };

    // localStorage backup
    try { localStorage.setItem('bws_eval_' + participantId, JSON.stringify(completionPayload)); } catch(e) {}

    // Save data
    if (typeof jatos !== 'undefined') {
      try {
        jatos.submitResultData(
          JSON.stringify(completionPayload),
          function() {
            // success
            document.getElementById('saveStatusMsg').className = 'save-status saved';
            document.getElementById('saveStatusMsg').innerHTML = '<span>&#10003; Results saved successfully!</span>';
            document.getElementById('btnProlific').disabled = false;
            document.getElementById('btnProlific').textContent = 'Return to Prolific';
          },
          function() {
            // error
            console.error('JATOS submitResultData failed');
            document.getElementById('saveStatusMsg').className = 'save-status failed';
            document.getElementById('saveStatusMsg').innerHTML = '<span>&#9888; Server save failed &mdash; please download your file below.</span>';
            showFallback();
          }
        );
      } catch (e) {
        console.error('JATOS save threw:', e);
        showFallback();
      }
    } else {
      // No JATOS — show download + email flow
      document.getElementById('saveStatusBox').classList.add('hidden');
      showFallback();
    }
  }

  function showFallback() {
    document.getElementById('fallbackDownload').classList.remove('hidden');
    document.getElementById('emailAddress').textContent = RESEARCHER_EMAIL;
    document.getElementById('pidDisplay').textContent = participantId;
    document.getElementById('btnProlific').disabled = false;
    document.getElementById('btnProlific').textContent = 'Return to Prolific';
    downloadResults();
  }

  function downloadResults() {
    if (!completionPayload) return;
    var blob = new Blob([JSON.stringify(completionPayload, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'bws_response_' + participantId + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    document.getElementById('downloadStatus').textContent = '\u2713 File downloaded';
    document.getElementById('downloadBtn').textContent = '\u2b07 Download Again';
  }

  function redirectToProlific() {
    if (typeof jatos !== 'undefined') {
      try {
        jatos.endStudy();
      } catch (e) {
        window.location.href = PROLIFIC_COMPLETION_URL;
      }
      // Fallback if endStudy doesn't redirect within 3s
      setTimeout(function() { window.location.href = PROLIFIC_COMPLETION_URL; }, 3000);
    } else {
      window.location.href = PROLIFIC_COMPLETION_URL;
    }
  }

  // ── Go ──
  init();
}

// ═══════════════════════════════════════════════════════════════════════════
// jsPsych 7 custom plugin (wraps runBwsExperiment)
// ═══════════════════════════════════════════════════════════════════════════
var jsPsychBwsEval;
if (typeof jsPsychModule !== 'undefined') {
  jsPsychBwsEval = (function(jspsych) {
    var info = {
      name: 'bws-eval',
      parameters: {}
    };

    function BwsEvalPlugin(jsPsych) {
      this.jsPsych = jsPsych;
    }

    BwsEvalPlugin.info = info;

    BwsEvalPlugin.prototype.trial = function(display_element) {
      // Hand control to our experiment (never calls finishTrial;
      // participant is redirected away by jatos.endStudy).
      runBwsExperiment(display_element);
    };

    return BwsEvalPlugin;
  })(jsPsychModule);
}

// ═══════════════════════════════════════════════════════════════════════════
// Boot — adapts to environment
// ═══════════════════════════════════════════════════════════════════════════
if (typeof jatos !== 'undefined' && typeof initJsPsych !== 'undefined' && jsPsychBwsEval) {
  // ── cognition.run (JATOS + jsPsych) ──
  jatos.onLoad(function() {
    var jsPsych = initJsPsych({
      on_finish: function() {
        // Safety net — normally jatos.endStudy() redirects before this fires
        if (typeof jatos !== 'undefined') jatos.endStudy();
      }
    });
    jsPsych.run([{ type: jsPsychBwsEval }]);
  });

} else if (typeof initJsPsych !== 'undefined' && jsPsychBwsEval) {
  // ── jsPsych available but no JATOS (unlikely) ──
  var jsPsych = initJsPsych({});
  jsPsych.run([{ type: jsPsychBwsEval }]);

} else {
  // ── No jsPsych (local testing / GitHub Pages) ──
  document.addEventListener('DOMContentLoaded', function() {
    runBwsExperiment(document.body);
  });
}
</script>
</html>
